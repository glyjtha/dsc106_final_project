<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Interactive fNIRS Heatmap – Sleep‑Deprivation Study</title>
  <style>
    /* —— Basic page layout —— */
    :root{color-scheme:light dark}
    body{margin:0;display:flex;flex-direction:column;align-items:center;font-family:system-ui,Arial,sans-serif;padding:1rem;gap:0.75rem}
    h2{margin:0;font-size:clamp(1.3rem,3vw,2rem);text-align:center}
    #controls{display:flex;gap:1.25rem;flex-wrap:wrap;font-size:0.9rem}
    #chart{box-shadow:0 2px 10px rgba(0,0,0,0.12);border-radius:10px;}
    /* —— Legend —— */
    .legend text{font-size:10px;dominant-baseline:middle}
    .legend-title{font-size:11px;font-weight:600;dominant-baseline:hanging}
    /* —— Tooltip —— */
    .tooltip-bg{fill:#fff;stroke:#333;stroke-width:0.6;opacity:0.9}
    .tooltip-text{font-size:11px;pointer-events:none}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
</head>
<body>

<h2>Frontal‑Lobe Channel Intensity (First 137 Channels)</h2>
<div id="controls">
  <label><input type="radio" name="dataset" value="pre" checked> Before Sleep Deprivation</label>
  <label><input type="radio" name="dataset" value="post"> After Sleep Deprivation</label>
</div>

<div id="chart"></div>

<script>
/* ----------------------------------------------------------------------- */
/*  Config                                                                 */
/* ----------------------------------------------------------------------- */
const SIZE  = 650;                         // SVG side length
const M     = {top:20,right:55,bottom:25,left:25};
const DOT_R = 7;                           // channel marker radius
const LEG_W = 24, LEG_H = 200;             // legend size

/* ----------------------------------------------------------------------- */
/*  SVG root & defs                                                        */
/* ----------------------------------------------------------------------- */
const svg = d3.select('#chart')
  .append('svg')
  .attr('viewBox',[0,0,SIZE,SIZE])
  .attr('width',SIZE)
  .attr('height',SIZE);

const defs = svg.append('defs');

function addGradient(id, scale){
  const g = defs.append('linearGradient')
    .attr('id',id)
    .attr('x1','0%').attr('y1','100%')
    .attr('x2','0%').attr('y2','0%');
  const steps = 60, [min,max] = scale.domain();
  for(let i=0;i<=steps;i++){
    const t = i/steps;
    g.append('stop')
     .attr('offset', (t*100)+'%')
     .attr('stop-color', scale(min + (max-min)*t));
  }
}

/* ----------------------------------------------------------------------- */
/*  Tooltip                                                                */
/* ----------------------------------------------------------------------- */
const tooltip = svg.append('g').style('display','none');
tooltip.append('rect')
  .attr('class','tooltip-bg')
  .attr('x',-45).attr('y',-15).attr('width',90).attr('height',22).attr('rx',4);
const tooltipTxt = tooltip.append('text')
  .attr('class','tooltip-text')
  .attr('text-anchor','middle')
  .attr('y',2);

/* ----------------------------------------------------------------------- */
/*  Helper – average intensity per channel                                 */
/* ----------------------------------------------------------------------- */
function avgByChannel(rows){
  const acc = new Map();
  rows.forEach(d=>{
    const ch = +d.channel;
    const v  = +d.mean_intensity;
    if(!acc.has(ch)) acc.set(ch,{s:0,c:0});
    const o = acc.get(ch); o.s += v; o.c += 1;
  });
  const arr = [];
  acc.forEach((o,ch)=>{ arr[ch-1] = o.s/o.c; });
  return arr.slice(0,137); // ensure first 137 channels
}

/* ----------------------------------------------------------------------- */
/*  Data loading                                                           */
/* ----------------------------------------------------------------------- */
Promise.all([
  d3.csv('Probe_location.csv', d3.autoType),
  d3.csv('fnirs_pre_summary.csv',  d3.autoType),
  d3.csv('fnirs_post_summary.csv', d3.autoType)
]).then(([rawLoc, preAll, postAll])=>{

  /* —— normalise probe coordinate headers (file has no header) —— */
  const loc = rawLoc.slice(0,137).map(d=>{
    const keys = Object.keys(d);
    return {x:+d[keys[0]], y:+d[keys[1]]};
  });

  /* —— prepare intensity arrays —— */
  const preVals  = avgByChannel(preAll);
  const postVals = avgByChannel(postAll);

  /* —— scales —— */
  const xExtent = d3.extent(loc,d=>d.x);
  const yExtent = d3.extent(loc,d=>d.y);
  const x = d3.scaleLinear().domain(xExtent).range([M.left, SIZE-M.right-LEG_W-8]);
  const y = d3.scaleLinear().domain(yExtent).range([SIZE-M.bottom, M.top]); // invert y
  const color = d3.scaleSequential()
                 .domain([d3.min(preVals.concat(postVals)), d3.max(preVals.concat(postVals))])
                 .interpolator(d3.interpolateViridis);
  addGradient('grad',color);

  /* —— legend —— */
  svg.append('rect')
     .attr('x', SIZE - M.right - LEG_W)
     .attr('y', M.top)
     .attr('width', LEG_W)
     .attr('height', LEG_H)
     .style('fill','url(#grad)');
  const legendScale = d3.scaleLinear().domain(color.domain()).range([LEG_H,0]);
  svg.append('g')
     .attr('class','legend')
     .attr('transform',`translate(${SIZE-M.right},${M.top})`)
     .call(d3.axisRight(legendScale).ticks(6));
  svg.append('text')
     .attr('class','legend-title')
     .attr('x', SIZE-M.right-LEG_W/2)
     .attr('y', M.top+LEG_H+4)
     .attr('text-anchor','middle')
     .text('Intensity');

  /* —— draw channels —— */
  function draw(which){
    const vals = which==='pre'?preVals:postVals;
    const data = loc.map((p,i)=>({...p,intensity:vals[i],idx:i+1}));
    const sel = svg.selectAll('.dot').data(data, d=>d.idx);
    sel.join(
      enter => enter.append('circle')
                      .attr('class','dot')
                      .attr('r',DOT_R)
                      .attr('cx',d=>x(d.x))
                      .attr('cy',d=>y(d.y))
                      .attr('fill',d=>color(d.intensity))
                      .on('mouseover',(ev,d)=>{
                        tooltip.style('display',null)
                               .attr('transform',`translate(${x(d.x)},${y(d.y)-12})`);
                        tooltipTxt.text(`Ch ${d.idx}: ${d.intensity.toFixed(3)}`);
                      })
                      .on('mouseout',()=>tooltip.style('display','none')),
      update => update.transition().duration(300)
                      .attr('fill',d=>color(d.intensity))
    );
  }
  draw('pre');

  /* —— radio controls —— */
  d3.selectAll('input[name=dataset]').on('change',function(){
    draw(this.value);
  });
});
</script>
</body>
</html>